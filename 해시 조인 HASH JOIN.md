# 해시 조인 HASH JOIN

HASH 조인은 조인될 두 테이블 중 하나를 해시 테이블로 선정하여 조인될 테이블의 조인 키 값을 해시 알고리즘으로 비교하여 매치되는 결과값을 얻는 방식이다.

 HASH JOIN은 비용 기반 옵티마이저를 사용할 때만 사용될 수 있는 조인 방식이며 '=' 비교를 통한 조인에서만 사용될 수 있고, 주로 많은 양의 데이터를 조인해야 하는 경우에 주로 사용된다.

### 사용 조건

**1.** JOIN 컬럼에 적당한 인덱스가 없어 NL JOIN이 비효율적일 때

**2.** JOIN Access량이 많아 Random Access 부하가 심하여 NL JOIN이 비효율적일 때

**3.** Sort Merge Join을 하기에는 두 테이블이 너무 커 Sort 부하가 심할 때

**4.** 수행빈도가 낮고 쿼리 수행 시간이 오래 걸리는 대용량 테이블을 JOIN 할 때

### 동작 방식

![Untitled](https://user-images.githubusercontent.com/48992412/201481062-62a51172-cfe8-4cf2-9ed7-2f467363df4e.png)

**1.** 둘 중 작은 집합(Build Input)을 읽어 Hash Area에 해시 테이블을 생성한다. (해시 함수에서 리턴 받은 버킷 주소로 찾아가 해시 체인에 엔트리를 연결)

**2.** 반대쪽 큰 집합(Probe Input)을 읽어 해시 테이블을 탐색하면서 JOIN 한다.

**3.** 해시 함수에서 리턴 받은 버킷 주소로 찾아가 해시 체인을 스캔하면서 데이터를 찾는다.

### HASH **JOIN의 장단점**

1. NL조인처럼 조인 과정에서 발생하는 Ramdom 액세스 부하가 없다.(단, 양쪽집합을 읽는 과장에서 인덱스를 이용한다면 Random 엑세스 발생)
2. 소트 머지 조인 처럼 조인 전에 미리 양쪽 집할을 정렬하는 부담도 없다.
3. NL조인과 달리 래치획등 과정없이 PGA에서 빠르게 데이터를 탐
4. 가장 비용이 많이 들어가는 조인방법으로 Driving Table이 작을 때 효과적이다.
5. 드라이빙 조건과 상관없이 좋은 성능을 발휘할 수 있는 조인 방법이며 대체로 제일 빠르다.

## **HASH JOIN의 성능 개선 포인트**

### **HASH TABLE을 만드는 과정을 효율화 한다.**

HASH JOIN은 해시 테이블을 생성하는 비용이 수반되므로 이 과정을 효율화하는 것이 성능 개선에 있어 가장 중요하다. 그렇기에 HASH TABLE로 만들 Build Input이 Hash Area에 담길 정도로 충분히 작아야 하며 Build Input 해시 키 칼럼에 중복 값이 거의 없어야 효율적인 동작을 기대할 수 있다.

### **CPU의 성능을 향상한다.**

HASH BUCKET이 조인 집합에 구성되어 해시 함수 결과를 저장해야 하는데 기본적으로HASH_AREA_SIZE에 지정된 크기만큼의 메모리가 할당되어 사용된다. 이러한 처리에는 많은 메모리와 CPU 자원을 소모하게 된다. 그렇기에 CPU의 자원이 넉넉하다면 다른 조인에 비해 보다 좋은 효율을 내지만 부족한 상황에서는 다른 조인 방법보다 느려질 수도 있다. 그러므로 CPU의 성능을 향상한다면 HASH JOIN의 성능을 향상할 수 있다.

- **HASH_AREA_SIZE**
  
    HASH JOIN에 사용되는 최대 메모리 SIZE를 지정하는 설정값입니다. Hash Join에서 사용되는 해쉬 메모리 크기(HASH_AREA_SIZE)의 기본 값은 SORT_AREA_SIZE의 2배입니다. 9i 이상에서 값을 지정하는 것을 권장하지 않고, PGA_AGGREGATE_TARGET parameter 사용을 권장합니다.