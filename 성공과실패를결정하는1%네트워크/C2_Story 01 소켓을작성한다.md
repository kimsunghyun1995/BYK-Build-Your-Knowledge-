# Story 01 소켓을 작성한다.

## 1. 프로토콜 스택의 내부 구성

- 

## 2. 소켓의 생성 단계

소켓을 만드는 방법은 Socket 라이브러리의 socket이라는 메서드를 호출하면 된다. 좀 더 자세히는 아래 코드와 같다.

```java
<디스크립터> = socket(<IPV4 사용>, <스트림형>, ...); //소켓 생성시 디스크립터를 return 해준다.

connect(<디스크립터>, <서버의 IP 주소와 포트 번호>); // 접속 단계

write(<디스크립터>, <송신데이터>, <송신데이터길이>); // 송수신 단계

<수신데이터 길이> = read(<디스크립터>, <수신버퍼>, ...);

close(<디스크립터>);
```

소켓 생성시 디스크립터를 return 해주는데 여기서 디스크립터는 소켓을 식별하기 위해 사용한다.

한 컴퓨터에 여러개의 송 수신 동작이 진행 됨으로 여러개의 소켓이 존재하게 되는데 이때, 소켓을 식별하기 위해 디스크립터를 사용하는 것이다.

## 3. 접속 단계

connect 메서드를 사용하고, 디스크립터, 서버의 IP 주소와 포트번호 값을 넣어줘야 한다.

여기서 포트번호는 데이터 송 수신 하기위해 상대방의 소켓과 연결해줘야하는데 이 때 상대방 소켓의 정보를 포트번호라고 한다.

**즉 IP 주소로 어느 컴퓨터에 접속할지, 포트번호로 컴퓨터의 어느 소켓에 접속할지를 판단한다.**

포트 번호로 접속 상대의 소켓을 지정할 수 있다라는 것을 알았다면, 몇 번으로 해야하는지에 대한 의문이 생긴다.

이는 서버측의 포트번호는 애플리케이션의 종류에 따라 미리 결정된 값을 사용한다는 규칙이 있다. 예를 들어 웹은 80번, 메일은 25번이다.

또한, 서버측도 클라이언트의 소켓 정보를 알아야하는데 이는 클라측에서 소켓을 만들 때 프로토콜 스택이 적당한 값을 골라서 할당하고, 이후 접속 동작을 실행할 때 서버측에 통지한다.

디스크립터와 포트번호에 대해 다시 한번 정리하면 아래와 같다.

- 디스크립터 : 애플리케이션이 소켓을 식별하는 것
- 포트 번호 : 클라이언트와 서버 간의 상대의 소켓을 식별하는 것

## 4. 메시지를 주고 받는 송 수신 단계

상대 측과의 소켓 연결이 확인 되면, write 메서드를 사용하는데 프로토콜 스택이 송신 데이터를 서버에 송신한다. 송신 데이터는 네트워크를 통해 전부 그대로 상대 서버에 도착하고, 수신 동작을 실행하여 받은 데이터의 내용을 받고, 적절한 처리를 실행하여 응답 메시지를 반송한다.

이 메시지가 돌아오면 수신을 해야하는데 이는 read 메서드를 사용한다. **이때 수신한 응답 메시지를 저장하기 위한 메모리 영역을 지정하는데 이를 수신 버퍼라 한다. 즉 read가 받아서 수신 버퍼에 저장한다.**

## 5. 연결 끊기 단계

브라우저가 데이터 수신을 완료하면 송 수신 동작은 끝난다. 이후 close 메서드를 사용하여 연결 끊기를 실행한다. 

HTTP 프로토콜을 예로 들자면 본래 응답 메시지의 송신을 완료했을 때 웹 서버측에서 연결 끊기 동작을 실행하여 close 메서드를 호출하여 연결을 끊는다. 이것이 클라이언트 측에 전달되어 클라이언트에서도 소켓 연결 끊기 단계로 들어간다.

위 로직이 HTTP의 본래 동작인데, 현재는 다른 버전의 프로토콜이 나와 request할 데이터가 없어진 상태에서 브라우저가 연결 끊기 동작을 실행하고 있다.