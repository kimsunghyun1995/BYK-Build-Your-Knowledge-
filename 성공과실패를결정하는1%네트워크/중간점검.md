인터넷에 접속 후 www.naver.com을 입력했을 때 벌어지는 일

![image-20230114012818350](C:\Users\tjdgu\AppData\Roaming\Typora\typora-user-images\image-20230114012818350.png)

### 1. 브라우저가 URL을 해독한다.

브라우저(크롬, 사파리)가 URL을 해독하는데 이는 서버에 저장된 파일(/index.html)을 가져오는 것이다.

www.naver.com은 파일명을 생략한 것으로 default 파일을 가져온다.

### 2. HTTP 프로토콜 사용

URL을 해독하면 액세스할 도메인명(www.naver.com)과 파일을 알 수 있다. 이때 HTTP 프로토콜을 사용하여 HTTP request 메시지를 만든다.

### 3. 도메인을 통해 IP 주소를 조사

www.naver.com을 IP로 찾는 과정을 진행한다.

액세스 대상의 서버(네이버의 서버)까지 메시지를 운반해야하는데 이는 IP 주소를 통해 알 수 있다.

IP 주소를 조사하는 방법은 Socket 라이브러리가 DNS 리졸버를 통해 진행하는데 리졸버에서 DNS 서버에 문의하기 위한 메시지를 만들어 DNS 서버에 전송한다.

### 4. 프로토콜 스택에 의뢰

IP 조사 이후 소켓을 만든 후, 접속 동작에 들어간다. 통신 상대와 제어 정보를 주고 받아 소켓에 필요한 정보를 기록하고 데이터 송 수신이 가능한 상태로 만든다.

통신 상대와 제어 정보를 주고 받기 위해 패킷을 만드는데 패킷에는 MAC헤더, IP 헤더, TCP 헤더, 데이터 조각이 있다. 

- 여기서 MAC 헤더는 다음 중계기 주소, IP 헤더는 목적지 서버 IP 정보, TCP 헤더는 제어정보(송,수신 포트번호, 컨트롤비트 등등)이 있다.

TCP 헤더에 SYN이라는 컨트롤비트를 1로 설정하고, IP 담당 부분(network layer)에게 건네주어 송신하도록 의뢰한다.

그 다음 라우터에 패킷이 도착할 수 있도록 MAC 헤더에 다음 라우터의 할당된 이더넷의 주소를 넣는다. 이후, 중계기를 거쳐가며(허브<이더넷규칙>, 라우터<IP규칙>) 목적지 서버에 패킷이 도착한다.

- 중계기에서는 MAC주소로만 이동한다.(이더넷)

--------------------------------------------------------------------도착-------------------------------------------------------------

서버에 패킷이 도착하면 IP 담당부분이 수신처 IP 주소와 LAN 어댑터에 할당 된 주소가 일치하는 지 확인하고, 패킷을 수신한다. 이때 수신한 IP주소와 자신의 주소가 다르면 ICMP라는 메시지를 사용하여 통신 상대에게 오류 통지한다.

이후, TCP 담당 부분은 IP 헤더에 기록된 수신처의 IP주소와 송신처 IP 주소, TCP 헤더에 기록된 수신처 포트 번호 및 송신처 포트 번호의 네 가지 항목을 조사하여 해당하는 소켓을 찾는다.

이후 위 과정을 다시 진행하고, TCP 헤더에 제어정보들을 수정하고(ACK을 1로 설정) 다시 IP 담당부분에 의뢰(network layer)한다.

다시 클라이언트에 패킷이 돌아오면 IP 담당부분 거쳐 TCP 담당으로 가고, TCP 헤더 조사 후, 접속 동작 성공하면 소켓은 데이터를 송 수신할 수 있는 상태가 된다. 이게 바로 커넥션이다.

커넥션 이후에 애플리케이션에 제어가 오면 송 수신 동작을 들어간다.

프로토콜 스택은 받은 데이터를 송신용 버퍼 메모리에 넣고, 데이터가 크면 분할하여 여러 패킷을 보낸다. 

이렇게 여러개의 패킷으로 나누어 보낼 대 ACK 번호를 이용하여 수신확인 동작과 시퀀스 번호(데이터를 어디까지 보냈는지)을 확인한다. 송신측에서 패킷을 보내는 방식은 윈도우 제어 방식을 사용하는데 지정한 윈도우 사이즈 크기 만큼 송신측에서 계속 패킷을 보냅니다.

수신측에서는 데이터에 문제가 없으면 ACK 번호를 반송하고, 데이터 조각을 수신 버퍼에 보관하고, 조각을 연결하여 애플리케이션에 건네준다.
